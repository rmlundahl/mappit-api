# Load the Laravel image for PHP 8.2
image: lorisleiva/laravel-docker:8.2

pipelines:
  branches:
    master:
      - step:
          name: Test
          script:
            - cp .env.testing .env 
            - export DB_HOST=127.0.0.1
            - composer install --no-interaction --no-progress --prefer-dist
            - php artisan migrate
            - php artisan test
          caches:
            - composer
          services:
            - mysql

definitions:
  services:
    mysql:
      image: mysql:8.0
      environment:
        MYSQL_DATABASE: 'testing'
        MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
        MYSQL_USER: 'db'
        MYSQL_PASSWORD: 'db'
